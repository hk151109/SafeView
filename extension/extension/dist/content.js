(function(){"use strict";const A={status:!0,blurryStartMode:!1,blurAmount:20,blurImages:!0,blurVideos:!0,blurMale:!1,blurFemale:!1,unblurImages:!1,unblurVideos:!1,gray:!0,strictness:.1},o={ERROR:"-1ERROR",OBSERVED:"0OBSERVED",QUEUED:"1QUEUED",LOADING:"2LOADING",LOADED:"3LOADED",PROCESSING:"4PROCESSING",PROCESSED:"5PROCESSED",DISABLED:"9DISABLED"},M=300,_=400,V=32,N=32,G=1920/4.5,F=1080/4.5,P=async t=>await new Promise((e,s)=>{t.setAttribute("crossorigin","anonymous"),t.readyState>=3&&t.videoHeight&&e(!0),t.onloadeddata=()=>{t.videoHeight?e(!0):s()},t.onerror=r=>{s("Failed to load video",t)}}),y=t=>t.width<V||t.height<N,W=(t,e,s="image")=>{let r=t,n=e;if(!t||!e)return{newWidth:r,newHeight:n};let a=s==="image"?_:G,i=s==="image"?M:F;if(r<n){const c=a;a=i,i=c}if(!(r<a&&n<i)){const c=Math.min(a/r,i/n);r=r*c,n=n*c}return{newWidth:r,newHeight:n}},U=(t,e)=>{var n,a;const s=((n=t==null?void 0:t.getElementsByTagName)==null?void 0:n.call(t,"img"))??[],r=((a=t==null?void 0:t.getElementsByTagName)==null?void 0:a.call(t,"video"))??[];for(let i=0;i<s.length+r.length;i++){const c=i<s.length?s[i]:r[i-s.length];c.tagName==="VIDEO"?e(c):c.tagName==="IMG"&&(c.complete&&y(c)&&c.naturalHeight||e(c))}(t.tagName==="IMG"||t.tagName==="VIDEO")&&e(t)},d=(t,e="")=>{const s=new CustomEvent(t,{detail:e});document.dispatchEvent(s)},m=(t,e)=>{document.addEventListener(t,e)},x=(t,e,s=!0)=>{let r;return s?r=new OffscreenCanvas(t,e):(r=document.getElementById("hb-in-canvas")??document.createElement("canvas"),r.id="hb-in-canvas",r.width=t,r.height=e,r.parentElement||document.body.appendChild(r)),r},$=(t,e)=>t.convertToBlob?t.convertToBlob(e):new Promise((s,r)=>{t.toBlob(n=>{s(n)},(e==null?void 0:e.type)||"image/jpeg",(e==null?void 0:e.quality)||.8)}),k=t=>{t.dataset.HBstatus=o.DISABLED,t.classList.remove("hb-blur")},j=t=>{t.dataset.HBstatus=o.PROCESSING};function q(t){const e=t.filter(s=>s.dataset.HBstatus===o.DISABLED&&!s.paused&&s.currentTime>0)??[];chrome.runtime.sendMessage({type:"video-status",status:e.length===0})}const X=window.requestIdleCallback||function(t){var e=Date.now();return setTimeout(function(){t({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)},v=7e3;let g,u;const S=({detail:t})=>{u=t,g=document.createElement("style"),g.id="hb-stylesheet",document.head.appendChild(g)},E=({detail:t})=>{if(u=t,g||S(),!u.shouldDetect()){g.innerHTML="";return}const e=u.shouldBlurImages(),s=u.shouldBlurVideos(),r=u.shouldUnblurImages(),n=u.shouldUnblurVideos();let a=[];e&&a.push("img.hb-blur"),s&&a.push("video.hb-blur"),a=a.join(", ");let i=[];r&&i.push("img.hb-blur:hover"),n&&i.push("video.hb-blur:hover"),i=i.join(", "),g.innerHTML=`
    ${a} {
      filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"brightness(0%)":""} !important;
      transition: filter 0.1s ease !important;
      opacity: unset !important;
    }
	
  `,i&&(g.innerHTML+=`
		${i} {
			filter: blur(0px) ${u.isGray()?"brightness(100%)":""} !important;
			transition: filter 0.5s ease !important;
			transition-delay: 1s !important;
		  }
	`),g.innerHTML+=`
	.hb-blur-temp { 
		animation: hb-blur-temp ${v}ms ease-in-out forwards !important;
	}

	#hb-in-canvas {
		display: none !important;
		visibility: hidden !important;
	}

	@keyframes hb-blur-temp {
		0% { filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"brightness(0%)":""}; }
		95% { filter: blur(${u.getBlurAmount()}px) ${u.isGray()?"brightness(0%)":""}; }
		100% { filter: blur(0px) ${u.isGray()?"brightness(100%)":""}; }
	}
  `},Q=t=>{u!=null&&u.isBlurryStartMode()&&t.classList.add("hb-blur-temp")},w=t=>{t.classList.remove("hb-blur-temp")},z=()=>{m("settingsLoaded",S),m("toggleOnOffStatus",E),m("changeBlurAmount",E),m("changeGray",E)},Y=1e3/25,R=1,Z=3,b={CLEAR:"CLEAR",NSFW:"NSFW",FACE:"FACE",ERROR:"ERROR"};let p=!1,f,O;const J=(t,e)=>{try{t.dataset.HBstatus=e.PROCESSING,chrome.runtime.sendMessage({type:"imageDetection",image:{src:t.src,width:t.width||t.naturalWidth,height:t.height||t.naturalHeight}},s=>{if(w(t),s.type==="error"){console.warn("HB==Error while processing image",s),t.dataset.HBstatus=e.ERROR;return}s==="face"||s==="nsfw"?(t.dataset.HBstatus=e.PROCESSED,t.classList.add("hb-blur"),t.dataset.HBresult=s):s==!1?(t.dataset.HBstatus=e.PROCESSED,t.classList.remove("hb-blur"),delete t.dataset.HBresult):(console.warn("HB==Unknown response from processing image",s),t.dataset.HBstatus=e.ERROR)})}catch(s){console.log("HB==ERROR",s)}},K=async(t,{width:e,height:s})=>{if(!(!t||t.ended))return new Promise(async(r,n)=>{try{O.drawImage(t,0,0,e,s);const a=await $(f,{type:"image/jpeg",quality:.6});let i=URL.createObjectURL(a);chrome.runtime.sendMessage({type:"videoDetection",frame:{data:i,timestamp:t.currentTime}},c=>{URL.revokeObjectURL(i),r(c)})}catch(a){n(a)}})},H=async(t,{width:e,height:s})=>{const r=performance.now();t!=null&&t.HBprevTime||(t.HBprevTime=r);const n=r-t.HBprevTime;if(t.dataset.HBstatus===o.DISABLED&&t.classList.remove("hb-blur"),!t.ended&&!t.paused&&t.dataset.HBstatus!==o.DISABLED)try{n>=Y&&(t.HBprevTime=r,p||(p=!0,K(t,{width:e,height:s}).then(({result:a,timestamp:i})=>{if(a==="error")throw new Error("HB==Error from processFrame");a!=="skipped"&&(t.currentTime-i>.5||et(a,t))}).catch(a=>{throw a}).finally(()=>{p=!1})))}catch(a){console.log("HB==Video detection loop error",a,t),t.dataset.HBerrored=parseInt(t.dataset.HBerrored??0)+1}if(t.dataset.HBerrored>10){t.onplay=null,cancelAnimationFrame(t.HBrafId),t.removeAttribute("crossorigin");return}t.paused?t.onplay=()=>{t.HBrafId=requestAnimationFrame(()=>H(t,{width:e,height:s}))}:t.HBrafId=requestAnimationFrame(()=>H(t,{width:e,height:s}))},tt=async t=>{try{t.dataset.HBstatus=o.LOADING,await P(t),t.dataset.HBstatus=o.PROCESSING;const{newWidth:e,newHeight:s}=W(t.videoWidth??t.clientWidth,t.videoHeight??t.clientHeight,"video");f||(f=x(e,s,!0),O=f.getContext("2d",{alpha:!1,willReadFrequently:!0})),t.width=e,t.height=s,(f.width!==e||f.height!==s)&&(f.width=e,f.height=s),w(t),X(()=>{H(t,{width:e,height:s})})}catch(e){console.log("HB== processVideo error",e)}},et=(t,e)=>{const s=e.dataset.HBresult,r=s===b.CLEAR||!s,n=parseInt(e.HBpositiveCount??0),a=parseInt(e.HBnegativeCount??0);let i=null;t==="nsfw"?(e.dataset.HBresult=b.NSFW,e.HBpositiveCount=n+!r,e.HBnegativeCount=0,n+!r>=R&&(i=!0,e.HBpositiveCount=0)):t==="face"?(e.dataset.HBresult=b.FACE,e.HBpositiveCount=n+!r,e.HBnegativeCount=0,n+!r>=R&&(i=!0,e.HBpositiveCount=0)):(e.dataset.HBresult=b.CLEAR,e.HBnegativeCount=a+r,e.HBpositiveCount=0,a+r>=Z&&(i=!1,e.HBnegativeCount=0)),i!==null&&(i?e.classList.add("hb-blur"):e.classList.remove("hb-blur"))};let l,h,B=[];const I=()=>{l||L(),l==null||l.observe(document,{childList:!0,characterData:!1,subtree:!0,attributes:!0,attributeFilter:["src"]})},L=()=>{l=new MutationObserver(t=>{t.forEach(e=>{if(e.type==="childList")e.addedNodes.forEach(s=>{U(s,r=>{C(r,!1)})});else if(e.type==="attributes"){const s=e.target;C(s,(e==null?void 0:e.attributeName)==="src")}})}),I()},st=()=>{m("settingsLoaded",({detail:t})=>{h=t,h.shouldDetect()?l||I():(l==null||l.disconnect(),l=null)}),m("toggleOnOffStatus",()=>{h!=null&&h.shouldDetect()?l||I():(l==null||l.disconnect(),l=null)}),chrome.runtime.onMessage.addListener((t,e,s)=>(t.type==="disable-detection"?B.filter(r=>r.dataset.HBstatus===o.PROCESSING&&!r.paused&&r.currentTime>0).forEach(r=>{k(r)}):t.type==="enable-detection"&&B.filter(r=>r.dataset.HBstatus===o.DISABLED&&!r.paused&&r.currentTime>0).forEach(r=>{j(r)}),!0))},rt=()=>{l==null||l.disconnect(),l=null};function C(t,e){var a,i,c,T;const s=t.tagName==="VIDEO";if(!(!s&&(!h||h.shouldDetectImages())||s&&(!h||h.shouldDetectVideos())))return;let r=s?(a=t.getElementsByTagName("source"))==null?void 0:a.length:0;(e||!t.dataset.HBstatus)&&(((i=t.src)==null?void 0:i.length)>0||r>0)&&(s||!y(t)||t.height===0||t.width===0)&&(Q(t),t.dataset.HBstatus=o.OBSERVED,(c=t.src)!=null&&c.length||r>0?t.tagName==="IMG"?J(t,o):t.tagName==="VIDEO"&&(tt(t),B.push(t),q(B)):(T=t.dataset)==null||delete T.HBstatus)}class D{constructor(e=A){this._settings=e}shouldDetectMale(){return this._settings.status?this._settings.blurMale:!1}shouldDetectFemale(){return this._settings.status?this._settings.blurFemale:!1}shouldDetectGender(){return this._settings.status?this.shouldDetectMale()||this.shouldDetectFemale():!1}shouldDetectImages(){return this._settings.status?this._settings.blurImages:!1}shouldDetectVideos(){return this._settings.status?this._settings.blurVideos:!1}shouldBlurImages(){return this.shouldDetectImages()}shouldBlurVideos(){return this.shouldDetectVideos()}shouldUnblurImages(){return this._settings.status?this._settings.unblurImages:!1}shouldUnblurVideos(){return this._settings.status?this._settings.unblurVideos:!1}shouldDetect(){return this._settings.status?this.shouldDetectImages()||this.shouldDetectVideos():!1}isBlurryStartMode(){return this.shouldDetect()?this._settings.blurryStartMode:!1}getBlurAmount(){return this.shouldDetect()?this._settings.blurAmount:0}getStrictness(){return this.shouldDetect()?this._settings.strictness:0}isGray(){return this.shouldDetect()?this._settings.gray:!1}getWhitelist(){return this._settings.whitelist}getSettings(){return this._settings}setSettings(e){this._settings=e}toggleOnOffStatus(){var e,s,r;(r=this._settings.whitelist)!=null&&r.includes(((s=(e=window.location.hostname)==null?void 0:e.split("www."))==null?void 0:s[1])??window.location.hostname)||d("toggleOnOffStatus",this)}listenForChanges(){chrome.runtime.onMessage.addListener((e,s,r)=>(e.type==="updateSettings"&&this.updateSettings(e.newSetting),!0))}static async init(e=null){const s=e??await new Promise(n=>{chrome.runtime.sendMessage({type:"getSettings"},a=>{n(a)})}),r=new D(s);return r.listenForChanges(),d("settingsLoaded",r),r}updateSettings(e){const{key:s,value:r}=e;switch(this._settings[s]=r,s){case"status":this.toggleOnOffStatus();break;case"blurAmount":d("changeBlurAmount",this);break;case"gray":d("changeGray",this);break}}}const at=()=>{z(),st(),chrome.runtime.onMessage.addListener((t,e,s)=>{t.type==="getCurrentWebsite"&&s({currentWebsite:window.location.hostname})})};window.self===window.top&&(at(),L(),D.init().then(t=>{var e,s;if(t.getWhitelist().includes(((s=(e=window.location.hostname)==null?void 0:e.split("www."))==null?void 0:s[1])??window.location.hostname)){console.log("HB==WHITELISTED SITE"),rt();return}t.toggleOnOffStatus()}).catch(t=>{console.log("HB==INITIALIZATION ERROR",t)}))})();
